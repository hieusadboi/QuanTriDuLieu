use doan;
-- hàm tìm dshs từ mã hs

--drop PROCEDURE TimDanhSachLop

DELIMITER $$
CREATE PROCEDURE TimDanhSachLop(IN maLopTimKiem VARCHAR(10))
BEGIN
    SELECT 
		hs.hs_malop AS 'Mã Lớp',
        l.tenLop AS 'Tên Lớp',
        hs.hs_maHS AS 'Mã Học Sinh',
        hs.hs_hoTen AS 'Tên Học Sinh',
        gv.gv_maGV AS 'Mã GV Chủ Nhiệm',
        gv.gv_hoTen AS 'Tên GV Chủ Nhiệm',
        ph.maPhong AS 'Mã Phòng',
        ph.soPhong AS 'Số Phòng',
        pl.hocKyNamHoc AS 'Học Kỳ - Năm Học'
    FROM 
        Lop AS l
    LEFT JOIN HocSinh AS hs ON l.maLop = hs.hs_maLop
    LEFT JOIN ChuNhiem AS cn ON l.maLop = cn.lop_maLop
    LEFT JOIN GiaoVien AS gv ON cn.gv_maGV = gv.gv_maGV
    LEFT JOIN PhongLop AS pl ON l.maLop = pl.maLop
    LEFT JOIN PhongHoc AS ph ON pl.maPhong = ph.maPhong
    WHERE 
        l.maLop = maLopTimKiem;
END$$

DELIMITER ;

CALL TimDanhSachLop("12A3")

-- tìm dshs và điểm tb của các hs từ maLop

--drop PROCEDURE TimDanhSachVaDiemTB

DELIMITER $$

CREATE PROCEDURE TimDanhSachVaDiemTB(IN maLopTimKiem VARCHAR(10))
BEGIN
    SELECT 
        hs.hs_maHS AS 'Mã Học Sinh',
        hs.hs_hoTen AS 'Tên Học Sinh',
        gv.gv_maGV AS 'Mã GV Chủ Nhiệm',
        gv.gv_hoTen AS 'Tên GV Chủ Nhiệm',
        ph.maPhong AS 'Mã Phòng',
        ph.soPhong AS 'Số Phòng',
        pl.hocKyNamHoc AS 'Học Kỳ - Năm Học',
        ROUND(AVG((d.diemMieng + d.diem15Phut + d.diem1Tiet + d.diemThi) / 4), 2) AS 'Điểm Trung Bình Cả Năm'
    FROM 
        Lop AS l
    LEFT JOIN HocSinh AS hs ON l.maLop = hs.hs_maLop
    LEFT JOIN ChuNhiem AS cn ON l.maLop = cn.lop_maLop
    LEFT JOIN GiaoVien AS gv ON cn.gv_maGV = gv.gv_maGV
    LEFT JOIN PhongLop AS pl ON l.maLop = pl.maLop
    LEFT JOIN PhongHoc AS ph ON pl.maPhong = ph.maPhong
    LEFT JOIN Diem AS d ON hs.hs_maHS = d.maHS
    WHERE 
        l.maLop = maLopTimKiem
    GROUP BY 
        hs.hs_maHS, hs.hs_hoTen, gv.gv_maGV, gv.gv_hoTen, ph.maPhong, ph.soPhong, pl.hocKyNamHoc;
END$$

DELIMITER ;

CALL TimDanhSachVaDiemTB('12A3');

-- Thống kê dựa vao maLop

DELIMITER $$
CREATE PROCEDURE ThongKeHocSinh(IN maLopTimKiem VARCHAR(10))
BEGIN
    -- Thống kê học sinh theo loại
    SELECT 
        CASE
            WHEN diemTB >= 8.0 THEN 'Giỏi'
            WHEN diemTB >= 6.5 THEN 'Khá'
            WHEN diemTB >= 5.0 THEN 'Trung Bình'
            WHEN diemTB >= 3.5 THEN 'Yếu'
            ELSE 'Kém'
        END AS 'Loại',
        COUNT(*) AS 'Số lượng',
        ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM HocSinh WHERE hs_maLop = maLopTimKiem), 2) AS 'Tỷ lệ (%)'
    FROM 
        (SELECT 
            hs.hs_maHS,
            ROUND(AVG((d.diemMieng + d.diem15Phut + d.diem1Tiet*2 + d.diemThi*3) / 7), 2) AS diemTB
         FROM 
            HocSinh AS hs
         LEFT JOIN Diem AS d ON hs.hs_maHS = d.maHS
         WHERE 
            hs.hs_maLop = maLopTimKiem
         GROUP BY 
            hs.hs_maHS
        ) AS DiemTBHocSinh
    GROUP BY 
        Loại;
END$$

DELIMITER ;

Call ThongKeHocSinh('12A3')

-- In Học Sinh Theo Loại từ mã Lớp
DELIMITER $$
-- drop procedure InDanhSachHocSinhTheoLoai

CREATE PROCEDURE InDanhSachHocSinhTheoLoai(IN maLopTimKiem VARCHAR(10))
BEGIN
    SELECT 
        hs.hs_maHS AS 'Mã Học Sinh',
        hs.hs_hoTen AS 'Tên Học Sinh',
        ROUND(AVG((d.diemMieng + d.diem15Phut + d.diem1Tiet * 2 + d.diemThi * 3) / 7), 2) AS 'Điểm Trung Bình',
        CASE
            WHEN AVG((d.diemMieng + d.diem15Phut + d.diem1Tiet * 2 + d.diemThi * 3) / 7) >= 8.0 THEN 'Giỏi'
            WHEN AVG((d.diemMieng + d.diem15Phut + d.diem1Tiet * 2 + d.diemThi * 3) / 7) >= 6.5 THEN 'Khá'
            WHEN AVG((d.diemMieng + d.diem15Phut + d.diem1Tiet * 2 + d.diemThi * 3) / 7) >= 5.0 THEN 'Trung Bình'
            WHEN AVG((d.diemMieng + d.diem15Phut + d.diem1Tiet * 2 + d.diemThi * 3) / 7) >= 3.5 THEN 'Yếu'
            ELSE 'Kém'
        END AS 'Loại'
    FROM 
        HocSinh AS hs
    LEFT JOIN Diem AS d ON hs.hs_maHS = d.maHS
    WHERE 
        hs.hs_maLop = maLopTimKiem
    GROUP BY 
        hs.hs_maHS, hs.hs_hoTen
    HAVING 
        `Loại` IN ('Giỏi', 'Khá', 'Trung Bình', 'Yếu'); -- Chỉ lấy các loại học sinh từ Yếu trở lên
END$$

DELIMITER ;


DELIMITER ;

CALL InDanhSachHocSinhTheoLoai('12A3');

-- Thống kê tỷ lệ xếp loại theo niên khóa


CALL ThongKeTatCaCacLopTrongNienKhoa('2021-2022');

